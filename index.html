<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SRTC ‚Äî Radio Tactique</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap');

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Courier Prime', monospace;
      background: #1c1c1c;
      color: #e0e0d0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .app { width: 100%; max-width: 380px; }

    .header {
      text-align: center;
      border: 2px solid #4a6741;
      padding: 12px;
      margin-bottom: 24px;
      background: #0f1a0f;
    }

    .header h1 { font-size: 0.95rem; letter-spacing: 0.3em; color: #7aaf6a; font-weight: 700; }
    .header p  { font-size: 0.6rem; color: #4a6741; letter-spacing: 0.2em; margin-top: 3px; }

    label {
      display: block;
      font-size: 0.65rem;
      color: #8a8a7a;
      letter-spacing: 0.15em;
      margin-bottom: 5px;
      text-transform: uppercase;
    }

    input {
      display: block;
      width: 100%;
      background: #0f0f0f;
      border: 1px solid #3a3a2a;
      color: #e0e0d0;
      padding: 9px 11px;
      font-family: 'Courier Prime', monospace;
      font-size: 0.95rem;
      letter-spacing: 0.08em;
      margin-bottom: 14px;
      outline: none;
    }

    input:focus { border-color: #7aaf6a; }
    input::placeholder { color: #3a3a2a; font-size: 0.8rem; }

    .btn {
      display: block;
      width: 100%;
      padding: 10px;
      background: #2a3a28;
      border: 1px solid #4a6741;
      color: #7aaf6a;
      font-family: 'Courier Prime', monospace;
      font-size: 0.8rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      cursor: pointer;
    }

    .btn:hover { background: #354a33; }

    .sep { text-align: center; color: #3a3a2a; font-size: 0.65rem; letter-spacing: 0.2em; margin: 12px 0; }

    .msg {
      margin-top: 12px;
      font-size: 0.68rem;
      letter-spacing: 0.08em;
      min-height: 1.2em;
      color: #8a8a7a;
    }
    .msg.err { color: #c05050; }
    .msg.ok  { color: #7aaf6a; }

    /* PTT screen */
    #ptt { display: none; }

    .infobox {
      border: 1px solid #3a3a2a;
      padding: 12px;
      margin-bottom: 14px;
      background: #0f0f0f;
    }

    .irow {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.75rem;
      margin-bottom: 5px;
    }
    .irow:last-child { margin-bottom: 0; }
    .irow .k { font-size: 0.6rem; color: #8a8a7a; letter-spacing: 0.12em; text-transform: uppercase; }
    .irow .v { color: #e0e0d0; letter-spacing: 0.06em; }
    .irow .v.g { color: #7aaf6a; }

    .cbtn {
      background: none;
      border: 1px solid #3a3a2a;
      color: #8a8a7a;
      padding: 2px 7px;
      font-family: 'Courier Prime', monospace;
      font-size: 0.58rem;
      letter-spacing: 0.1em;
      cursor: pointer;
    }
    .cbtn:hover { border-color: #7aaf6a; color: #7aaf6a; }

    .users {
      border: 1px solid #3a3a2a;
      margin-bottom: 14px;
      min-height: 36px;
    }

    .urow {
      padding: 6px 11px;
      font-size: 0.75rem;
      border-bottom: 1px solid #2a2a1a;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .urow:last-child { border-bottom: none; }
    .urow .un { color: #c0c0b0; }
    .urow .un.me { color: #7aaf6a; }
    .urow .ub {
      font-size: 0.58rem;
      letter-spacing: 0.1em;
      padding: 1px 5px;
      border: 1px solid #3a3a2a;
      color: #8a8a7a;
    }
    .urow .ub.sp { border-color: #7aaf6a; color: #7aaf6a; animation: bl .6s infinite; }
    .urow .ub.tx { border-color: #c05050; color: #c05050; }

    @keyframes bl { 0%,100%{opacity:1} 50%{opacity:.2} }

    .ptt-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      margin: 8px 0 14px;
    }

    #ptt-btn {
      width: 130px;
      height: 130px;
      border-radius: 50%;
      border: 3px solid #4a6741;
      background: #1a2a18;
      color: #7aaf6a;
      font-family: 'Courier Prime', monospace;
      font-size: 0.65rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 7px;
      box-shadow: 0 4px 0 #0a0a08, inset 0 1px 0 rgba(255,255,255,0.04);
      user-select: none;
      -webkit-user-select: none;
      transition: all 0.08s;
    }

    #ptt-btn .icon { font-size: 1.8rem; }

    #ptt-btn.tx {
      transform: translateY(3px);
      box-shadow: 0 1px 0 #0a0a08;
      border-color: #c05050;
      background: #2a1010;
      color: #c05050;
    }

    .rxline {
      font-size: 0.62rem;
      letter-spacing: 0.12em;
      color: #4a4a3a;
      text-align: center;
    }
    .rxline.rx { color: #7aaf6a; }
    .rxline.tx { color: #c05050; }

    .hint { font-size: 0.58rem; color: #3a3a2a; letter-spacing: 0.1em; text-align: center; }

    /* loading */
    #loading { display: none; text-align: center; padding: 28px 0; }
    .spin { font-size: 0.72rem; color: #8a8a7a; letter-spacing: 0.15em; }
  </style>
</head>
<body>
<div class="app">

  <div class="header">
    <h1>‚ñåSRTC ‚Äî Radio Tactique</h1>
    <p>GENDARMERIE NATIONALE ¬∑ R√âSEAU P2P</p>
  </div>

  <!-- SETUP -->
  <div id="setup">
    <label>Cr√©er un canal</label>
    <input id="in-name" type="text" placeholder="nom du canal (ex: ALPHA-7)"/>
    <button class="btn" id="btn-create" onclick="doCreate()">‚ñ∂ Cr√©er le canal</button>

    <div class="sep">‚Äî ou ‚Äî</div>

    <label>Rejoindre un canal</label>
    <input id="in-code"      type="text" placeholder="code du canal"/>
    <input id="in-callsign"  type="text" placeholder="votre indicatif (ex: ADJ MARTIN)"/>
    <button class="btn" id="btn-join" onclick="doJoin()">‚ñ∂ Rejoindre</button>

    <div class="msg" id="msg"></div>
  </div>

  <!-- LOADING -->
  <div id="loading">
    <div class="spin" id="loading-txt">Connexion...</div>
  </div>

  <!-- PTT -->
  <div id="ptt">
    <div class="infobox">
      <div class="irow"><span class="k">Canal</span><span class="v" id="d-canal">‚Äî</span></div>
      <div class="irow"><span class="k">Indicatif</span><span class="v g" id="d-cs">‚Äî</span></div>
      <div class="irow"><span class="k">Unit√©s</span><span class="v" id="d-units">0</span></div>
      <div class="irow"><span class="k">Partager</span><button class="cbtn" id="cbtn" onclick="copyCode()">COPIER CODE</button></div>
    </div>

    <div class="users" id="ulist"></div>

    <div class="ptt-wrap">
      <div class="rxline" id="rxline">EN VEILLE</div>
      <button id="ptt-btn"
        onmousedown="startTx()" onmouseup="stopTx()"
        ontouchstart="startTx(event)" ontouchend="stopTx(event)">
        <div class="icon">üéô</div>
        <div id="ptt-lbl">PARLER</div>
      </button>
      <div class="hint">Maintenir ¬∑ [ESPACE]</div>
    </div>
  </div>

</div>
<div id="audios" style="display:none"></div>

<script>
const $ = id => document.getElementById(id);

let peer       = null;
let myId       = '';
let myCallsign = '';
let roomId     = '';
let isHost     = false;
let micStream  = null;
const peers    = {}; // id -> {conn, call, callsign, speaking}

// ‚îÄ‚îÄ UI helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showMsg(t, cls='') { $('msg').textContent = t; $('msg').className = 'msg ' + cls; }
function showSetup()   { $('setup').style.display='block'; $('loading').style.display='none'; $('ptt').style.display='none'; }
function showLoading(t){ $('setup').style.display='none'; $('loading').style.display='block'; $('ptt').style.display='none'; $('loading-txt').textContent = t||'Connexion...'; }
function showPTT()     { $('setup').style.display='none'; $('loading').style.display='none'; $('ptt').style.display='block'; }

function setBtns(disabled) {
  $('btn-create').disabled = disabled;
  $('btn-join').disabled   = disabled;
}

// ‚îÄ‚îÄ Audio ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function addAudio(pid, stream) {
  removeAudio(pid);
  const a = document.createElement('audio');
  a.id = 'a-' + pid; a.autoplay = true; a.srcObject = stream;
  $('audios').appendChild(a);
  a.play().catch(()=>{});
}
function removeAudio(pid) { const e=$('a-'+pid); if(e) e.remove(); }
function silentStream()   { return new AudioContext().createMediaStreamDestination().stream; }

// ‚îÄ‚îÄ Mic ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function getMic() {
  micStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
  micStream.getAudioTracks().forEach(t => t.enabled = false);
}

// ‚îÄ‚îÄ Render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function render() {
  const ul = $('ulist');
  ul.innerHTML = '';
  // Me
  const me = document.createElement('div');
  me.className = 'urow';
  me.innerHTML = `<span class="un me">‚ñ∂ ${esc(myCallsign)}</span><span class="ub" id="b-me">MOI</span>`;
  ul.appendChild(me);
  // Others
  for (const [id, p] of Object.entries(peers)) {
    const d = document.createElement('div');
    d.className = 'urow'; d.id = 'r-' + id;
    d.innerHTML = `<span class="un">${esc(p.callsign)}</span><span class="ub ${p.speaking?'sp':''}">${p.speaking?'‚óè PARLE':'EN LIGNE'}</span>`;
    ul.appendChild(d);
  }
  $('d-units').textContent = Object.keys(peers).length;
  updateRx();
}

function updateRx() {
  const sp = Object.values(peers).filter(p => p.speaking);
  const rx = $('rxline');
  if (sp.length) {
    rx.className = 'rxline rx';
    rx.textContent = '‚óè R√âCEPTION ‚Äî ' + sp.map(p=>p.callsign).join(', ');
  } else {
    rx.className = 'rxline';
    rx.textContent = 'EN VEILLE';
  }
}

function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;'); }

function copyCode() {
  navigator.clipboard.writeText(roomId.replace('srtc-','')).then(() => {
    $('cbtn').textContent = 'COPI√â !';
    setTimeout(() => $('cbtn').textContent = 'COPIER CODE', 2000);
  });
}

// ‚îÄ‚îÄ Data messages ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function broadcast(msg) {
  for (const p of Object.values(peers))
    if (p.conn && p.conn.open) try { p.conn.send(msg); } catch(e) {}
}

function onData(fromId, msg) {
  if (!peers[fromId]) return;
  if (msg.type === 'hello') { peers[fromId].callsign = msg.callsign; render(); }
  if (msg.type === 'speaking') { peers[fromId].speaking = msg.val; render(); }
  if (msg.type === 'peers') {
    for (const p of msg.list)
      if (p.id !== myId && !peers[p.id]) connectOut(p.id, p.callsign);
  }
}

// ‚îÄ‚îÄ Connect outgoing to a peer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function connectOut(pid, knownCs) {
  if (peers[pid]) return;
  peers[pid] = { conn: null, call: null, callsign: knownCs || '???', speaking: false };

  const conn = peer.connect(pid, { reliable: true, serialization: 'json' });
  peers[pid].conn = conn;
  conn.on('open', () => {
    conn.send({ type: 'hello', callsign: myCallsign });
    // Tell them about our other peers
    const list = Object.entries(peers).filter(([id])=>id!==pid).map(([id,p])=>({id,callsign:p.callsign}));
    if (list.length) conn.send({ type: 'peers', list });
  });
  conn.on('data',  msg => onData(pid, msg));
  conn.on('close', ()  => { delete peers[pid]; removeAudio(pid); render(); });
  conn.on('error', ()  => { delete peers[pid]; removeAudio(pid); render(); });

  // Media
  const call = peer.call(pid, micStream);
  peers[pid].call = call;
  call.on('stream', s => addAudio(pid, s));
  call.on('close',  () => removeAudio(pid));
  call.on('error',  () => removeAudio(pid));

  render();
}

// ‚îÄ‚îÄ Setup incoming listeners (used by both host & joiner) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setupPeerListeners() {
  // Incoming data connection
  peer.on('connection', conn => {
    const pid = conn.peer;
    if (!peers[pid]) peers[pid] = { conn, call: null, callsign: '???', speaking: false };
    else peers[pid].conn = conn;

    conn.on('open', () => {
      conn.send({ type: 'hello', callsign: myCallsign });
      if (isHost) {
        // Send existing peers to newcomer
        const list = Object.entries(peers).filter(([id])=>id!==pid).map(([id,p])=>({id,callsign:p.callsign}));
        if (list.length) conn.send({ type: 'peers', list });
        // Tell existing peers about newcomer
        broadcast({ type: 'peers', list: [{ id: pid, callsign: peers[pid].callsign }] });
      }
    });
    conn.on('data',  msg => onData(pid, msg));
    conn.on('close', ()  => { delete peers[pid]; removeAudio(pid); render(); });
    conn.on('error', ()  => { delete peers[pid]; removeAudio(pid); render(); });
    render();
  });

  // Incoming media call
  peer.on('call', call => {
    const pid = call.peer;
    if (!peers[pid]) peers[pid] = { conn: null, call, callsign: '???', speaking: false };
    else peers[pid].call = call;
    call.answer(micStream);
    call.on('stream', s => addAudio(pid, s));
    call.on('close',  () => removeAudio(pid));
    render();
  });

  peer.on('disconnected', () => peer.reconnect());
}

// ‚îÄ‚îÄ Go to PTT screen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function goToPTT() {
  $('d-canal').textContent = roomId.replace('srtc-','').toUpperCase();
  $('d-cs').textContent    = myCallsign;
  showPTT();
  render();
}

// ‚îÄ‚îÄ CREATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function doCreate() {
  const raw = $('in-name').value.trim().replace(/\s+/g,'-') || Math.random().toString(36).substr(2,5).toUpperCase();
  roomId     = 'srtc-' + raw;
  myCallsign = 'COMMANDANT';
  isHost     = true;

  setBtns(true);
  showMsg('Acc√®s microphone...');
  try { await getMic(); } catch(e) { showMsg('Micro refus√© : '+e.message,'err'); setBtns(false); return; }

  showLoading('Ouverture du canal...');

  peer = new Peer(roomId, { debug: 0 });

  peer.on('open', id => {
    myId = id;
    setupPeerListeners();
    goToPTT();
  });

  peer.on('error', e => {
    showSetup();
    setBtns(false);
    if (e.type === 'unavailable-id') showMsg('Ce nom de canal est d√©j√† pris, essayez un autre.','err');
    else showMsg('Erreur : '+e.type,'err');
  });
}

// ‚îÄ‚îÄ JOIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function doJoin() {
  const code = $('in-code').value.trim();
  const cs   = $('in-callsign').value.trim();
  if (!code) { showMsg('Entrez un code de canal.','err'); return; }

  roomId     = code.startsWith('srtc-') ? code : 'srtc-'+code;
  myCallsign = cs || 'AGENT-' + Math.random().toString(36).substr(2,4).toUpperCase();
  isHost     = false;

  setBtns(true);
  showMsg('Acc√®s microphone...');
  try { await getMic(); } catch(e) { showMsg('Micro refus√© : '+e.message,'err'); setBtns(false); return; }

  showLoading('Connexion au canal...');

  peer = new Peer(undefined, { debug: 0 });

  peer.on('open', id => {
    myId = id;
    setupPeerListeners();

    // Connect to host ‚Äî data first
    peers[roomId] = { conn: null, call: null, callsign: 'COMMANDANT', speaking: false };

    const conn = peer.connect(roomId, { reliable: true, serialization: 'json' });
    peers[roomId].conn = conn;

    let connected = false;

    conn.on('open', () => {
      connected = true;
      conn.send({ type: 'hello', callsign: myCallsign });

      // Media to host
      const call = peer.call(roomId, micStream);
      peers[roomId].call = call;
      call.on('stream', s => addAudio(roomId, s));
      call.on('close',  () => removeAudio(roomId));
      call.on('error',  () => {});

      goToPTT();
    });

    conn.on('data',  msg => onData(roomId, msg));
    conn.on('close', ()  => { if (peers[roomId]) { delete peers[roomId]; removeAudio(roomId); render(); } });
    conn.on('error', ()  => {
      if (!connected) {
        showSetup(); setBtns(false); showMsg('Canal introuvable ‚Äî v√©rifiez le code.','err');
      }
    });
  });

  peer.on('error', e => {
    showSetup();
    setBtns(false);
    if (e.type === 'peer-unavailable') showMsg('Canal introuvable ‚Äî v√©rifiez le code.','err');
    else showMsg('Erreur r√©seau : '+e.type,'err');
  });
}

// ‚îÄ‚îÄ PTT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startTx(e) {
  if (e) e.preventDefault();
  if (!micStream) return;
  micStream.getAudioTracks().forEach(t => t.enabled = true);
  $('ptt-btn').classList.add('tx');
  $('ptt-lbl').textContent = '√âMISSION';
  $('rxline').className = 'rxline tx';
  $('rxline').textContent = '‚óè VOUS TRANSMETTEZ';
  broadcast({ type: 'speaking', val: true });
}

function stopTx(e) {
  if (e) e.preventDefault();
  if (!micStream) return;
  micStream.getAudioTracks().forEach(t => t.enabled = false);
  $('ptt-btn').classList.remove('tx');
  $('ptt-lbl').textContent = 'PARLER';
  broadcast({ type: 'speaking', val: false });
  updateRx();
}

document.addEventListener('keydown', e => {
  if (e.code==='Space' && $('ptt').style.display!=='none') { e.preventDefault(); if(!e.repeat) startTx(); }
});
document.addEventListener('keyup', e => {
  if (e.code==='Space' && $('ptt').style.display!=='none') stopTx();
});
</script>
</body>
</html>
