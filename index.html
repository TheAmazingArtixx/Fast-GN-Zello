<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SRTC ‚Äî R√©seau Radio Tactique</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Special+Elite&family=VT323&family=Courier+Prime:wght@400;700&display=swap');

    :root {
      --paper:    #d4c9a8;
      --paper2:   #c8bb96;
      --ink:      #1a1a14;
      --ink-fade: #4a4535;
      --navy:     #1a2540;
      --gold:     #8a6d20;
      --red:      #8b1a1a;
      --green:    #1a5c2a;
      --border:   #7a6840;
      --stripe:   rgba(0,0,0,0.04);
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background-color: #2a2418;
      background-image:
        repeating-linear-gradient(0deg, var(--stripe) 0px, var(--stripe) 1px, transparent 1px, transparent 24px);
      font-family: 'Courier Prime', monospace;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px 16px 40px;
    }

    /* ===== DOCUMENT CONTAINER ===== */
    .document {
      width: 100%;
      max-width: 680px;
      background: var(--paper);
      border: 1px solid var(--border);
      box-shadow:
        4px 4px 0 #1a1a0a,
        8px 8px 0 #0f0f08,
        inset 0 0 80px rgba(0,0,0,0.06);
      position: relative;
    }

    /* Texture grain */
    .document::before {
      content: '';
      position: absolute;
      inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
      pointer-events: none;
      z-index: 1;
      border-radius: 0;
    }

    /* Red margin line */
    .document::after {
      content: '';
      position: absolute;
      top: 0; bottom: 0;
      left: 52px;
      width: 1px;
      background: rgba(139,26,26,0.35);
      z-index: 2;
      pointer-events: none;
    }

    /* ===== HEADER STAMP ===== */
    .doc-header {
      border-bottom: 3px double var(--border);
      padding: 18px 24px 14px 64px;
      position: relative;
      z-index: 3;
      background: linear-gradient(180deg, #cfc49f, var(--paper));
    }

    .header-top {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
    }

    .republic-block {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    /* Marianne SVG */
    .emblem {
      width: 52px;
      height: 52px;
      flex-shrink: 0;
    }

    .org-title { line-height: 1.2; }

    .org-title .rep {
      font-family: 'Special Elite', serif;
      font-size: 0.6rem;
      color: var(--ink-fade);
      letter-spacing: 0.2em;
      text-transform: uppercase;
    }

    .org-title .main {
      font-family: 'Special Elite', serif;
      font-size: 1.05rem;
      color: var(--navy);
      letter-spacing: 0.05em;
      font-weight: bold;
    }

    .org-title .sub {
      font-size: 0.68rem;
      color: var(--ink-fade);
      letter-spacing: 0.08em;
    }

    .doc-ref {
      text-align: right;
      font-size: 0.62rem;
      color: var(--ink-fade);
      line-height: 1.7;
    }

    .doc-ref .ref-num {
      font-family: 'VT323', monospace;
      font-size: 1rem;
      color: var(--navy);
      letter-spacing: 0.1em;
    }

    .classif-stamp {
      margin-top: 10px;
      padding: 4px 10px;
      border: 2px solid var(--red);
      display: inline-block;
      color: var(--red);
      font-family: 'Special Elite', serif;
      font-size: 0.65rem;
      letter-spacing: 0.3em;
      text-transform: uppercase;
      transform: rotate(-1deg);
    }

    .doc-title-bar {
      margin-top: 12px;
      padding: 8px 0;
      border-top: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
      text-align: center;
    }

    .doc-title-bar h1 {
      font-family: 'Special Elite', serif;
      font-size: 1.1rem;
      color: var(--navy);
      letter-spacing: 0.25em;
      text-transform: uppercase;
    }

    .doc-title-bar .subtitle {
      font-size: 0.65rem;
      color: var(--ink-fade);
      letter-spacing: 0.15em;
      margin-top: 2px;
    }

    /* ===== BODY ===== */
    .doc-body {
      padding: 24px 24px 24px 64px;
      position: relative;
      z-index: 3;
    }

    /* ===== SECTION ===== */
    .section { margin-bottom: 22px; }

    .section-title {
      font-family: 'Special Elite', serif;
      font-size: 0.75rem;
      color: var(--navy);
      letter-spacing: 0.2em;
      text-transform: uppercase;
      border-bottom: 1px solid var(--border);
      padding-bottom: 4px;
      margin-bottom: 14px;
    }

    /* ===== TABS (old style radio buttons) ===== */
    .mode-select {
      display: flex;
      gap: 0;
      margin-bottom: 18px;
      border: 1px solid var(--border);
    }

    .mode-btn {
      flex: 1;
      padding: 9px 12px;
      background: var(--paper2);
      border: none;
      border-right: 1px solid var(--border);
      color: var(--ink-fade);
      cursor: pointer;
      font-family: 'Courier Prime', monospace;
      font-size: 0.78rem;
      letter-spacing: 0.1em;
      text-align: center;
      transition: background 0.15s, color 0.15s;
    }

    .mode-btn:last-child { border-right: none; }

    .mode-btn.active {
      background: var(--navy);
      color: var(--paper);
    }

    /* ===== FORM FIELDS ===== */
    .field {
      margin-bottom: 14px;
    }

    .field label {
      display: block;
      font-size: 0.7rem;
      color: var(--ink-fade);
      letter-spacing: 0.12em;
      margin-bottom: 5px;
      text-transform: uppercase;
    }

    .field input {
      width: 100%;
      background: #ede5c8;
      border: 1px solid var(--border);
      border-radius: 0;
      padding: 8px 10px;
      font-family: 'VT323', monospace;
      font-size: 1.1rem;
      color: var(--ink);
      letter-spacing: 0.08em;
      outline: none;
      transition: border-color 0.15s;
    }

    .field input:focus {
      border-color: var(--navy);
      background: #f0e8cc;
    }

    .field input::placeholder {
      color: var(--border);
      font-size: 0.9rem;
    }

    /* ===== BUTTON ===== */
    .btn {
      display: block;
      width: 100%;
      padding: 10px 16px;
      background: var(--navy);
      color: var(--paper);
      border: 2px solid var(--navy);
      cursor: pointer;
      font-family: 'Special Elite', serif;
      font-size: 0.88rem;
      letter-spacing: 0.25em;
      text-transform: uppercase;
      transition: background 0.15s, color 0.15s;
      text-align: center;
    }

    .btn:hover { background: var(--ink); border-color: var(--ink); }

    /* ===== ERROR ===== */
    .error {
      display: none;
      margin-top: 12px;
      padding: 8px 12px;
      border: 1px solid var(--red);
      background: rgba(139,26,26,0.06);
      font-size: 0.72rem;
      color: var(--red);
      letter-spacing: 0.08em;
    }

    /* ===== STATUS TABLE ===== */
    .status-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.75rem;
      margin-bottom: 6px;
    }

    .status-table td {
      padding: 5px 8px;
      border: 1px solid var(--border);
      vertical-align: middle;
    }

    .status-table td:first-child {
      background: var(--paper2);
      color: var(--ink-fade);
      letter-spacing: 0.1em;
      font-size: 0.65rem;
      text-transform: uppercase;
      width: 38%;
    }

    .status-table td:last-child {
      font-family: 'VT323', monospace;
      font-size: 1rem;
      color: var(--ink);
      letter-spacing: 0.08em;
    }

    .pill {
      display: inline-block;
      padding: 1px 8px;
      font-size: 0.62rem;
      letter-spacing: 0.12em;
      font-family: 'Courier Prime', monospace;
    }

    .pill.green { background: rgba(26,92,42,0.15); color: var(--green); border: 1px solid var(--green); }
    .pill.red   { background: rgba(139,26,26,0.15); color: var(--red); border: 1px solid var(--red); }
    .pill.navy  { background: rgba(26,37,64,0.15); color: var(--navy); border: 1px solid var(--navy); }

    /* ===== PTT BUTTON ===== */
    .ptt-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 18px;
      padding: 24px 0;
    }

    #ptt-btn {
      width: 160px;
      height: 160px;
      border-radius: 50%;
      background: radial-gradient(circle at 38% 32%, #3a4f7a, var(--navy));
      border: 5px solid var(--ink);
      box-shadow:
        0 6px 0 #0a0a08,
        0 8px 12px rgba(0,0,0,0.5),
        inset 0 2px 4px rgba(255,255,255,0.08);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 0.1s;
      user-select: none;
      -webkit-user-select: none;
      position: relative;
    }

    #ptt-btn:active, #ptt-btn.tx {
      transform: translateY(4px);
      box-shadow:
        0 2px 0 #0a0a08,
        0 3px 6px rgba(0,0,0,0.5),
        inset 0 2px 6px rgba(0,0,0,0.4);
    }

    #ptt-btn.tx {
      background: radial-gradient(circle at 38% 32%, #7a2020, var(--red));
    }

    .ptt-mic { font-size: 2.6rem; }

    .ptt-label {
      font-family: 'VT323', monospace;
      font-size: 0.88rem;
      letter-spacing: 0.22em;
      color: rgba(255,255,255,0.7);
      text-align: center;
      line-height: 1.3;
    }

    #ptt-btn.tx .ptt-label { color: rgba(255,200,200,0.9); }

    .ptt-hint {
      font-size: 0.66rem;
      color: var(--ink-fade);
      letter-spacing: 0.1em;
      text-align: center;
      line-height: 1.8;
    }

    /* ===== USERS LIST ===== */
    #users-list {
      list-style: none;
      border: 1px solid var(--border);
      font-family: 'VT323', monospace;
      font-size: 0.95rem;
    }

    #users-list li {
      padding: 6px 10px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      letter-spacing: 0.08em;
      color: var(--ink);
    }

    #users-list li:last-child { border-bottom: none; }

    #users-list li .badge {
      font-size: 0.7rem;
      padding: 1px 6px;
      letter-spacing: 0.1em;
      font-family: 'Courier Prime', monospace;
    }

    #users-list li.speaking { background: rgba(26,92,42,0.12); }
    #users-list li.speaking .badge { background: var(--green); color: #fff; }

    /* ===== RECEPTION INDICATOR ===== */
    .reception-block {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      background: var(--paper2);
      font-size: 0.72rem;
      color: var(--ink-fade);
      letter-spacing: 0.1em;
    }

    .reception-block .dot {
      width: 10px; height: 10px;
      border-radius: 50%;
      background: var(--border);
      flex-shrink: 0;
    }

    .reception-block.active { background: rgba(26,92,42,0.1); border-color: var(--green); color: var(--green); }
    .reception-block.active .dot { background: var(--green); box-shadow: 0 0 6px var(--green); animation: blink .5s infinite; }
    .reception-block.tx-active { background: rgba(139,26,26,0.1); border-color: var(--red); color: var(--red); }
    .reception-block.tx-active .dot { background: var(--red); box-shadow: 0 0 6px var(--red); animation: blink .4s infinite; }

    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.2} }

    /* ===== FOOTER ===== */
    .doc-footer {
      border-top: 3px double var(--border);
      padding: 10px 24px 12px 64px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.6rem;
      color: var(--ink-fade);
      letter-spacing: 0.1em;
      position: relative;
      z-index: 3;
    }

    #clock {
      font-family: 'VT323', monospace;
      font-size: 1rem;
      color: var(--navy);
      letter-spacing: 0.12em;
    }

    /* ===== DIVIDER ===== */
    .divider {
      border: none;
      border-top: 1px solid var(--border);
      margin: 18px 0;
    }

    hr.double {
      border: none;
      border-top: 3px double var(--border);
      margin: 20px 0;
    }

    /* Helpers */
    #op-section { display: none; }
  </style>
</head>
<body>

<div class="document">

  <!-- HEADER -->
  <div class="doc-header">
    <div class="header-top">
      <div class="republic-block">
        <!-- Blason simplifi√© -->
        <svg class="emblem" viewBox="0 0 52 52" fill="none" xmlns="http://www.w3.org/2000/svg">
          <ellipse cx="26" cy="26" rx="24" ry="24" fill="#1a2540" stroke="#8a6d20" stroke-width="1.5"/>
          <ellipse cx="26" cy="26" rx="20" ry="20" fill="none" stroke="#8a6d20" stroke-width="0.6" opacity="0.5"/>
          <!-- Fasces stylis√©es -->
          <rect x="22" y="14" width="3" height="26" rx="1" fill="#8a6d20" opacity="0.9"/>
          <rect x="19" y="16" width="3" height="22" rx="1" fill="#8a6d20" opacity="0.6"/>
          <rect x="25" y="16" width="3" height="22" rx="1" fill="#8a6d20" opacity="0.6"/>
          <!-- Hache -->
          <path d="M22 14 L18 10 L28 14 L22 14Z" fill="#8a6d20"/>
          <!-- RF -->
          <text x="26" y="45" text-anchor="middle" font-family="serif" font-size="7" font-weight="bold" fill="#d4c9a8" letter-spacing="2">GN</text>
        </svg>
        <div class="org-title">
          <div class="rep">R√©publique Fran√ßaise</div>
          <div class="main">GENDARMERIE NATIONALE</div>
          <div class="sub">Direction G√©n√©rale ‚Äî Section Transmissions</div>
        </div>
      </div>
      <div class="doc-ref">
        <div>R√©f. : SRTC/TN/2024</div>
        <div class="ref-num" id="session-ref">‚Äî</div>
        <div style="margin-top:6px"><div class="classif-stamp">CONFIDENTIEL</div></div>
      </div>
    </div>

    <div class="doc-title-bar">
      <h1>Syst√®me Radio Tactique Connect√©</h1>
      <div class="subtitle">R√âSEAU PUSH-TO-TALK ¬∑ CHIFFREMENT P2P ¬∑ USAGE RESTREINT</div>
    </div>
  </div>

  <!-- BODY -->
  <div class="doc-body">

    <!-- ===== SETUP ===== -->
    <div id="setup-section">

      <div class="section">
        <div class="section-title">I. ‚Äî Initialisation du canal</div>

        <div class="mode-select">
          <button class="mode-btn active" onclick="setTab('host')">üì° Cr√©er un canal</button>
          <button class="mode-btn" onclick="setTab('join')">üìª Rejoindre un canal</button>
        </div>

        <div id="host-panel">
          <div class="field">
            <label>D√©signation du canal :</label>
            <input id="host-room-input" type="text" placeholder="ex : ALPHA-7, BRAVO-2, OPS-NORD..." maxlength="24"/>
          </div>
          <button class="btn" onclick="startHost()">‚ñ∂ Ouvrir le canal</button>
        </div>

        <div id="join-panel" style="display:none">
          <div class="field">
            <label>Code d'acc√®s du canal :</label>
            <input id="join-room-input" type="text" placeholder="code fourni par le responsable canal..." maxlength="24"/>
          </div>
          <div class="field">
            <label>Votre matricule / indicatif :</label>
            <input id="callsign-input" type="text" placeholder="ex : ADJ MARTIN, GEND-42..." maxlength="20"/>
          </div>
          <button class="btn" onclick="startJoin()">‚ñ∂ Rejoindre le canal</button>
        </div>

        <div class="error" id="error-msg"></div>
      </div>

      <hr class="double"/>

      <div class="section">
        <div class="section-title">II. ‚Äî √âtat des syst√®mes</div>
        <table class="status-table">
          <tr><td>Protocole</td><td>WebRTC / P2P direct</td></tr>
          <tr><td>Chiffrement</td><td><span class="pill green">DTLS-SRTP ¬∑ AES-256</span></td></tr>
          <tr><td>Codec audio</td><td>OPUS 48kHz</td></tr>
          <tr><td>Infrastructure</td><td>Aucun serveur central</td></tr>
        </table>
      </div>

    </div>

    <!-- ===== OPERATIONAL ===== -->
    <div id="op-section">

      <div class="section">
        <div class="section-title">I. ‚Äî Identification du canal</div>
        <table class="status-table">
          <tr>
            <td>Canal actif</td>
            <td><strong id="room-display" style="font-family:'VT323',monospace;font-size:1.1rem;letter-spacing:.1em">‚Äî</strong></td>
          </tr>
          <tr>
            <td>Votre indicatif</td>
            <td id="my-callsign-display">‚Äî</td>
          </tr>
          <tr>
            <td>Unit√©s connect√©es</td>
            <td><span id="peer-count">0</span> unit√©(s)</td>
          </tr>
          <tr>
            <td>Code d'acc√®s</td>
            <td>
              <span id="share-code" style="font-family:'VT323',monospace;font-size:1rem">‚Äî</span>
              &nbsp;<button onclick="copyRoom()" style="font-size:0.6rem;padding:1px 6px;border:1px solid var(--border);background:var(--paper2);cursor:pointer;font-family:'Courier Prime',monospace;letter-spacing:.08em">COPIER</button>
            </td>
          </tr>
          <tr>
            <td>√âtat liaison</td>
            <td id="status-cell"><span class="pill navy">INITIALISATION</span></td>
          </tr>
        </table>
      </div>

      <hr class="double"/>

      <div class="section">
        <div class="section-title">II. ‚Äî Contr√¥le de transmission</div>

        <div class="ptt-wrap">
          <!-- R√©ception indicator -->
          <div class="reception-block" id="rx-indicator">
            <div class="dot"></div>
            <span id="rx-text">EN VEILLE ‚Äî AUCUNE TRANSMISSION EN COURS</span>
          </div>

          <!-- PTT Button -->
          <button id="ptt-btn"
            onmousedown="startTalking()" onmouseup="stopTalking()"
            ontouchstart="startTalking(event)" ontouchend="stopTalking(event)">
            <div class="ptt-mic">üéôÔ∏è</div>
            <div class="ptt-label" id="ptt-label">APPUYER<br>POUR PARLER</div>
          </button>

          <div class="ptt-hint">
            Maintenir appuy√© pour √©mettre ‚Äî rel√¢cher pour couper<br>
            Raccourci clavier : <strong>[BARRE ESPACE]</strong>
          </div>
        </div>
      </div>

      <hr class="double"/>

      <div class="section">
        <div class="section-title">III. ‚Äî Unit√©s sur le canal</div>
        <ul id="users-list">
          <li style="color:var(--ink-fade);font-size:.72rem;font-family:'Courier Prime',monospace">Aucune unit√© connect√©e pour l'instant...</li>
        </ul>
      </div>

    </div>

  </div>

  <!-- FOOTER -->
  <div class="doc-footer">
    <span>GN/DG/SECT.TRANS ‚Äî Document √† usage interne exclusif</span>
    <div id="clock">--:--:--</div>
    <span>R√©v. 3.1.4 ‚Äî 2024</span>
  </div>

</div>

<!-- Audio elements container -->
<div id="audio-container" style="display:none"></div>

<script>
// =============================================
// CLOCK
// =============================================
function updateClock() {
  const n = new Date();
  const pad = x => String(x).padStart(2,'0');
  document.getElementById('clock').textContent = pad(n.getHours())+':'+pad(n.getMinutes())+':'+pad(n.getSeconds());
}
setInterval(updateClock, 1000);
updateClock();

// =============================================
// STATE
// =============================================
let peer        = null;
let myCallsign  = '';
let roomId      = '';
let myPeerId    = '';
let isHost      = false;

// Mesh : map peerId => { conn (DataConnection), call (MediaCall), callsign, speaking }
const meshPeers = {};

// Our mic stream
let micStream = null;

// Session ref
const sessionRef = 'SID-' + Math.random().toString(36).substr(2,8).toUpperCase();
document.getElementById('session-ref').textContent = sessionRef;

// =============================================
// TAB
// =============================================
function setTab(t) {
  isHost = t === 'host';
  document.querySelectorAll('.mode-btn').forEach((el,i) =>
    el.classList.toggle('active', (i===0&&t==='host')||(i===1&&t==='join')));
  document.getElementById('host-panel').style.display = t==='host'?'block':'none';
  document.getElementById('join-panel').style.display = t==='join'?'block':'none';
}

// =============================================
// HELPERS
// =============================================
function showError(msg) {
  const el = document.getElementById('error-msg');
  el.textContent = '‚ö† ' + msg;
  el.style.display = 'block';
}

function setStatus(text, cls='') {
  const pills = { ok:'green', wait:'navy', tx:'red', err:'red' };
  document.getElementById('status-cell').innerHTML =
    `<span class="pill ${pills[cls]||'navy'}">${text}</span>`;
}

function updatePeerCount() {
  document.getElementById('peer-count').textContent = Object.keys(meshPeers).length;
  renderUsersList();
}

function renderUsersList() {
  const ul = document.getElementById('users-list');
  const entries = Object.entries(meshPeers);
  if (entries.length === 0) {
    ul.innerHTML = '<li style="color:var(--ink-fade);font-size:.72rem;font-family:\'Courier Prime\',monospace">Aucune unit√© connect√©e pour l\'instant...</li>';
    return;
  }
  ul.innerHTML = '';
  // Me first
  const meItem = document.createElement('li');
  meItem.id = 'user-me';
  meItem.innerHTML = `<span>‚ñ∂ ${escHtml(myCallsign)} <span style="font-size:.65rem;color:var(--ink-fade)">(vous)</span></span><span class="badge pill navy">EN LIGNE</span>`;
  ul.appendChild(meItem);
  for (const [pid, info] of entries) {
    const li = document.createElement('li');
    li.id = 'user-' + pid;
    li.className = info.speaking ? 'speaking' : '';
    const badge = info.speaking
      ? '<span class="badge">‚óè PARLE</span>'
      : '<span class="badge pill navy">EN LIGNE</span>';
    li.innerHTML = `<span>${escHtml(info.callsign||pid.substr(0,8))}</span>${badge}`;
    ul.appendChild(li);
  }
}

function escHtml(str) {
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function copyRoom() {
  const code = roomId.replace('srtc-','');
  navigator.clipboard.writeText(code).then(() => {
    const btn = event.target;
    const old = btn.textContent;
    btn.textContent = 'COPI√â !';
    setTimeout(()=>btn.textContent=old, 2000);
  });
}

// =============================================
// MIC
// =============================================
async function getMic() {
  micStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
  // Start muted
  micStream.getAudioTracks().forEach(t => t.enabled = false);
  return micStream;
}

function getSilentStream() {
  const ctx = new AudioContext();
  return ctx.createMediaStreamDestination().stream;
}

// =============================================
// SWITCH TO OPS
// =============================================
function switchToOps() {
  document.getElementById('setup-section').style.display = 'none';
  document.getElementById('op-section').style.display   = 'block';
  document.getElementById('room-display').textContent   = roomId.replace('srtc-','').toUpperCase();
  document.getElementById('share-code').textContent     = roomId.replace('srtc-','').toUpperCase();
  document.getElementById('my-callsign-display').textContent = myCallsign;
  setStatus('CANAL ACTIF ‚Äî EN VEILLE', 'ok');
  updatePeerCount();
}

// =============================================
// DATA PROTOCOL ‚Äî messages √©chang√©s
// On utilise des DataConnections pour signaler
// qui parle, pour √©changer les listes de peers,
// et pour faire les introductions.
//
// Messages :
//   { type: 'hello', callsign, peerId }
//   { type: 'peer-list', peers: [{peerId, callsign}] }
//   { type: 'speaking', speaking: bool }
// =============================================

function sendToAll(data) {
  for (const [pid, info] of Object.entries(meshPeers)) {
    if (info.conn && info.conn.open) {
      try { info.conn.send(data); } catch(e) {}
    }
  }
}

function handleDataMsg(fromPeerId, msg) {
  if (!meshPeers[fromPeerId]) return;
  if (msg.type === 'hello') {
    meshPeers[fromPeerId].callsign = msg.callsign;
    renderUsersList();
  }
  if (msg.type === 'speaking') {
    meshPeers[fromPeerId].speaking = msg.speaking;
    updateRxIndicator();
    renderUsersList();
  }
  // peer-list : l'h√¥te nous envoie la liste des autres pairs pour qu'on se connecte
  if (msg.type === 'peer-list') {
    for (const p of msg.peers) {
      if (p.peerId !== myPeerId && !meshPeers[p.peerId]) {
        connectToPeer(p.peerId, p.callsign);
      }
    }
  }
}

function updateRxIndicator() {
  const anyoneSpeaking = Object.values(meshPeers).some(p => p.speaking);
  const el = document.getElementById('rx-indicator');
  const txt = document.getElementById('rx-text');
  if (anyoneSpeaking) {
    const who = Object.values(meshPeers).filter(p=>p.speaking).map(p=>p.callsign||'???').join(', ');
    el.className = 'reception-block active';
    txt.textContent = '‚óè R√âCEPTION ‚Äî ' + who.toUpperCase() + ' EN COURS DE TRANSMISSION';
  } else {
    el.className = 'reception-block';
    txt.textContent = 'EN VEILLE ‚Äî AUCUNE TRANSMISSION EN COURS';
  }
}

// =============================================
// CONNECT TO A PEER (bidirectional)
// =============================================
function connectToPeer(peerId, knownCallsign) {
  if (meshPeers[peerId]) return; // d√©j√† connect√©
  meshPeers[peerId] = { conn: null, call: null, callsign: knownCallsign||peerId.substr(0,8), speaking: false };

  // Data connection
  const conn = peer.connect(peerId, { reliable: true });
  meshPeers[peerId].conn = conn;

  conn.on('open', () => {
    conn.send({ type: 'hello', callsign: myCallsign, peerId: myPeerId });
    // Si h√¥te : on envoie la liste de tous les pairs au nouveau
    if (isHost) {
      const peerList = Object.entries(meshPeers)
        .filter(([pid]) => pid !== peerId)
        .map(([pid, info]) => ({ peerId: pid, callsign: info.callsign }));
      conn.send({ type: 'peer-list', peers: peerList });
    }
  });

  conn.on('data', msg => handleDataMsg(peerId, msg));
  conn.on('close', () => removePeer(peerId));
  conn.on('error', () => removePeer(peerId));

  // Media call ‚Äî on envoie notre flux mic, on re√ßoit le leur
  callMedia(peerId);

  updatePeerCount();
}

function callMedia(peerId) {
  const stream = micStream || getSilentStream();
  const call = peer.call(peerId, stream);
  if (!meshPeers[peerId]) return;
  meshPeers[peerId].call = call;

  call.on('stream', remoteStream => {
    addAudioElement(peerId, remoteStream);
  });
  call.on('close', () => { removeAudioElement(peerId); });
  call.on('error', () => { removeAudioElement(peerId); });
}

function removePeer(peerId) {
  if (meshPeers[peerId]) {
    removeAudioElement(peerId);
    delete meshPeers[peerId];
    updatePeerCount();
    updateRxIndicator();
  }
}

function addAudioElement(peerId, stream) {
  removeAudioElement(peerId);
  const audio = document.createElement('audio');
  audio.id = 'audio-' + peerId;
  audio.autoplay = true;
  audio.srcObject = stream;
  document.getElementById('audio-container').appendChild(audio);
  audio.play().catch(()=>{});
}

function removeAudioElement(peerId) {
  const existing = document.getElementById('audio-' + peerId);
  if (existing) existing.remove();
}

// =============================================
// HOST
// =============================================
async function startHost() {
  let raw = document.getElementById('host-room-input').value.trim().replace(/\s+/g,'-') || '';
  roomId = raw ? 'srtc-'+raw : 'srtc-'+Math.random().toString(36).substr(2,6).toUpperCase();
  myCallsign = 'COMMANDANT';
  isHost = true;

  try { await getMic(); }
  catch(e) { showError('Acc√®s microphone refus√© : '+e.message); return; }

  peer = new Peer(roomId, { debug: 0 });
  peer.on('open', pid => {
    myPeerId = pid;
    switchToOps();
  });

  // Quand un pair nous appelle en media
  peer.on('call', call => {
    const pid = call.peer;
    if (!meshPeers[pid]) {
      meshPeers[pid] = { conn: null, call: null, callsign: pid.substr(0,8), speaking: false };
    }
    meshPeers[pid].call = call;
    call.answer(micStream);
    call.on('stream', remoteStream => addAudioElement(pid, remoteStream));
    call.on('close', ()=>{ removeAudioElement(pid); });
    updatePeerCount();
  });

  // Quand un pair ouvre une data connexion
  peer.on('connection', conn => {
    const pid = conn.peer;
    if (!meshPeers[pid]) {
      meshPeers[pid] = { conn: null, call: null, callsign: pid.substr(0,8), speaking: false };
    }
    meshPeers[pid].conn = conn;

    conn.on('open', () => {
      conn.send({ type: 'hello', callsign: myCallsign, peerId: myPeerId });
      // Envoyer liste de pairs existants
      const peerList = Object.entries(meshPeers)
        .filter(([p]) => p !== pid)
        .map(([p,info]) => ({ peerId: p, callsign: info.callsign }));
      if (peerList.length > 0) conn.send({ type: 'peer-list', peers: peerList });
      // Notifier tous les autres qu'un nouveau est arriv√©
      sendToAll({ type: 'peer-list', peers: [{ peerId: pid, callsign: meshPeers[pid].callsign }] });
    });
    conn.on('data', msg => handleDataMsg(pid, msg));
    conn.on('close', ()=>removePeer(pid));
    conn.on('error', ()=>removePeer(pid));
    updatePeerCount();
  });

  peer.on('error', e => showError('Erreur r√©seau : '+e.message));
}

// =============================================
// JOIN
// =============================================
async function startJoin() {
  const code = document.getElementById('join-room-input').value.trim();
  const cs   = document.getElementById('callsign-input').value.trim();
  if (!code) { showError("Code d'acc√®s requis"); return; }
  myCallsign = cs || 'AGENT-' + Math.random().toString(36).substr(2,4).toUpperCase();
  roomId = code.startsWith('srtc-') ? code : 'srtc-'+code;
  isHost = false;

  try { await getMic(); }
  catch(e) { showError('Acc√®s microphone refus√© : '+e.message); return; }

  peer = new Peer(undefined, { debug: 0 });

  peer.on('open', pid => {
    myPeerId = pid;

    // Se connecter √† l'h√¥te
    meshPeers[roomId] = { conn: null, call: null, callsign: 'COMMANDANT', speaking: false };

    // Data conn vers l'h√¥te
    const conn = peer.connect(roomId, { reliable: true });
    meshPeers[roomId].conn = conn;

    conn.on('open', () => {
      conn.send({ type: 'hello', callsign: myCallsign, peerId: myPeerId });
      switchToOps();
    });
    conn.on('data', msg => handleDataMsg(roomId, msg));
    conn.on('close', ()=>removePeer(roomId));
    conn.on('error', ()=>{ showError('Connexion perdue avec le canal'); });

    // Appel m√©dia vers l'h√¥te
    const call = peer.call(roomId, micStream);
    meshPeers[roomId].call = call;
    call.on('stream', remoteStream => addAudioElement(roomId, remoteStream));
    call.on('close', ()=>removeAudioElement(roomId));
    call.on('error', ()=>{});

    setTimeout(()=>{
      if(document.getElementById('setup-section').style.display!=='none')
        showError('Canal introuvable ‚Äî v√©rifiez le code d\'acc√®s.');
    }, 9000);
  });

  // Recevoir des appels des autres pairs (mesh)
  peer.on('call', call => {
    const pid = call.peer;
    if (!meshPeers[pid]) {
      meshPeers[pid] = { conn: null, call: null, callsign: pid.substr(0,8), speaking: false };
    }
    meshPeers[pid].call = call;
    call.answer(micStream);
    call.on('stream', remoteStream => addAudioElement(pid, remoteStream));
    call.on('close', ()=>removeAudioElement(pid));
    updatePeerCount();
  });

  // Recevoir des data connexions des autres pairs
  peer.on('connection', conn => {
    const pid = conn.peer;
    if (!meshPeers[pid]) {
      meshPeers[pid] = { conn: null, call: null, callsign: pid.substr(0,8), speaking: false };
    }
    meshPeers[pid].conn = conn;
    conn.on('open', ()=>{ conn.send({ type:'hello', callsign: myCallsign, peerId: myPeerId }); });
    conn.on('data', msg=>handleDataMsg(pid, msg));
    conn.on('close', ()=>removePeer(pid));
    conn.on('error', ()=>removePeer(pid));
    updatePeerCount();
  });

  peer.on('error', e => {
    if(e.type==='peer-unavailable') showError('Canal introuvable ‚Äî code invalide ou canal ferm√©.');
    else showError('Erreur : '+e.message);
  });
}

// =============================================
// PTT
// =============================================
function startTalking(e) {
  if(e) e.preventDefault();
  if(!micStream) return;
  micStream.getAudioTracks().forEach(t=>t.enabled=true);
  document.getElementById('ptt-btn').classList.add('tx');
  document.getElementById('ptt-label').innerHTML='EN COURS<br>D\'√âMISSION';
  const el = document.getElementById('rx-indicator');
  el.className = 'reception-block tx-active';
  document.getElementById('rx-text').textContent = '‚óè √âMISSION EN COURS ‚Äî VOUS TRANSMETTEZ';
  setStatus('√âMISSION EN COURS', 'tx');
  sendToAll({ type: 'speaking', speaking: true });
  // Me marquer dans la liste
  const me = document.getElementById('user-me');
  if(me) { me.className='speaking'; me.querySelector('.badge').textContent='‚óè PARLE'; }
}

function stopTalking(e) {
  if(e) e.preventDefault();
  if(!micStream) return;
  micStream.getAudioTracks().forEach(t=>t.enabled=false);
  document.getElementById('ptt-btn').classList.remove('tx');
  document.getElementById('ptt-label').innerHTML='APPUYER<br>POUR PARLER';
  setStatus('CANAL ACTIF ‚Äî EN VEILLE','ok');
  sendToAll({ type: 'speaking', speaking: false });
  const me = document.getElementById('user-me');
  if(me) { me.className=''; me.querySelector('.badge').textContent=''; me.querySelector('.badge').className='badge pill navy'; me.querySelector('.badge').textContent='EN LIGNE'; }
  updateRxIndicator();
}

// Keyboard
document.addEventListener('keydown', e => {
  if(e.code==='Space' && document.getElementById('op-section').style.display!=='none') {
    e.preventDefault();
    if(!e.repeat) startTalking();
  }
});
document.addEventListener('keyup', e => {
  if(e.code==='Space' && document.getElementById('op-section').style.display!=='none') stopTalking();
});
</script>
</body>
</html>
