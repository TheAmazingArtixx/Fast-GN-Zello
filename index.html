<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SRTC ‚Äî Radio Tactique</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap');

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Courier Prime', monospace;
      background: #1c1c1c;
      color: #e0e0d0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .app {
      width: 100%;
      max-width: 400px;
    }

    /* Header */
    .header {
      text-align: center;
      border: 2px solid #4a6741;
      padding: 12px;
      margin-bottom: 24px;
      background: #0f1a0f;
    }

    .header h1 {
      font-size: 1rem;
      letter-spacing: 0.3em;
      color: #7aaf6a;
      font-weight: 700;
      text-transform: uppercase;
    }

    .header p {
      font-size: 0.65rem;
      color: #4a6741;
      letter-spacing: 0.2em;
      margin-top: 4px;
    }

    /* Screens */
    #screen-setup, #screen-channel, #screen-ptt { display: none; }
    #screen-setup { display: block; }

    /* Labels */
    label {
      display: block;
      font-size: 0.7rem;
      color: #8a8a7a;
      letter-spacing: 0.15em;
      margin-bottom: 6px;
      text-transform: uppercase;
    }

    /* Inputs */
    input {
      display: block;
      width: 100%;
      background: #0f0f0f;
      border: 1px solid #3a3a2a;
      color: #e0e0d0;
      padding: 10px 12px;
      font-family: 'Courier Prime', monospace;
      font-size: 1rem;
      letter-spacing: 0.1em;
      margin-bottom: 16px;
      outline: none;
    }

    input:focus { border-color: #7aaf6a; }
    input::placeholder { color: #3a3a2a; }

    /* Buttons */
    button.btn {
      display: block;
      width: 100%;
      padding: 11px;
      background: #2a3a28;
      border: 1px solid #4a6741;
      color: #7aaf6a;
      font-family: 'Courier Prime', monospace;
      font-size: 0.85rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      cursor: pointer;
      transition: background 0.15s;
    }

    button.btn:hover { background: #354a33; }
    button.btn:disabled { opacity: 0.4; cursor: not-allowed; }

    /* Divider */
    .or {
      text-align: center;
      color: #3a3a2a;
      font-size: 0.7rem;
      letter-spacing: 0.2em;
      margin: 14px 0;
    }

    /* Status line */
    .status {
      font-size: 0.7rem;
      color: #8a8a7a;
      letter-spacing: 0.1em;
      margin-top: 12px;
      min-height: 1.2em;
    }

    .status.err { color: #c05050; }
    .status.ok  { color: #7aaf6a; }

    /* Channel screen */
    .info-box {
      border: 1px solid #3a3a2a;
      padding: 14px;
      margin-bottom: 16px;
      background: #0f0f0f;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.8rem;
      margin-bottom: 6px;
    }

    .info-row:last-child { margin-bottom: 0; }

    .info-row .key { color: #8a8a7a; font-size: 0.65rem; letter-spacing: 0.15em; text-transform: uppercase; }
    .info-row .val { color: #e0e0d0; letter-spacing: 0.08em; }
    .info-row .val.green { color: #7aaf6a; }

    .copy-btn {
      background: none;
      border: 1px solid #3a3a2a;
      color: #8a8a7a;
      padding: 2px 8px;
      font-family: 'Courier Prime', monospace;
      font-size: 0.6rem;
      letter-spacing: 0.1em;
      cursor: pointer;
      transition: all 0.15s;
      width: auto;
      display: inline-block;
      margin-bottom: 0;
    }

    .copy-btn:hover { border-color: #7aaf6a; color: #7aaf6a; }

    /* Users list */
    .users {
      border: 1px solid #3a3a2a;
      margin-bottom: 16px;
      min-height: 48px;
    }

    .users .u-row {
      padding: 7px 12px;
      font-size: 0.78rem;
      border-bottom: 1px solid #2a2a1a;
      display: flex;
      align-items: center;
      justify-content: space-between;
      letter-spacing: 0.06em;
    }

    .users .u-row:last-child { border-bottom: none; }
    .users .u-row .u-name { color: #c0c0b0; }
    .users .u-row .u-name.me { color: #7aaf6a; }
    .users .u-row .u-badge {
      font-size: 0.6rem;
      letter-spacing: 0.12em;
      padding: 1px 6px;
      border: 1px solid #3a3a2a;
      color: #8a8a7a;
    }
    .users .u-row .u-badge.speaking {
      border-color: #7aaf6a;
      color: #7aaf6a;
      animation: blink .6s infinite;
    }

    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.3} }

    /* PTT Button */
    .ptt-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 14px;
      margin: 8px 0 16px;
    }

    #ptt-btn {
      width: 140px;
      height: 140px;
      border-radius: 50%;
      border: 3px solid #4a6741;
      background: #1a2a18;
      color: #7aaf6a;
      font-family: 'Courier Prime', monospace;
      font-size: 0.7rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      text-align: center;
      cursor: pointer;
      transition: all 0.1s;
      user-select: none;
      -webkit-user-select: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 4px 0 #0a0f0a, inset 0 1px 0 rgba(255,255,255,0.05);
    }

    #ptt-btn .ptt-icon { font-size: 2rem; }

    #ptt-btn:active, #ptt-btn.tx {
      transform: translateY(3px);
      box-shadow: 0 1px 0 #0a0f0a, inset 0 2px 4px rgba(0,0,0,0.4);
      border-color: #c05050;
      background: #2a1010;
      color: #c05050;
    }

    .rx-line {
      font-size: 0.65rem;
      letter-spacing: 0.15em;
      color: #4a4a3a;
      text-align: center;
      height: 1.2em;
    }

    .rx-line.active { color: #7aaf6a; }
    .rx-line.tx { color: #c05050; }

    /* Connecting overlay */
    .connecting {
      text-align: center;
      padding: 30px 0;
      color: #8a8a7a;
      font-size: 0.75rem;
      letter-spacing: 0.15em;
    }

    .dot-anim::after {
      content: '';
      animation: dots 1.2s infinite;
    }
    @keyframes dots {
      0%  { content: '.'; }
      33% { content: '..'; }
      66% { content: '...'; }
    }
  </style>
</head>
<body>
<div class="app">

  <div class="header">
    <h1>‚ñåSRTC ‚Äî Radio Tactique</h1>
    <p>GENDARMERIE NATIONALE ¬∑ R√âSEAU P2P CHIFFR√â</p>
  </div>

  <!-- ===== SETUP ===== -->
  <div id="screen-setup">

    <label>Cr√©er un canal</label>
    <input id="inp-create" type="text" placeholder="nom du canal (ex: ALPHA-7)..."/>
    <button class="btn" onclick="doCreate()">‚ñ∂ Cr√©er</button>

    <div class="or">‚Äî ou ‚Äî</div>

    <label>Rejoindre un canal existant</label>
    <input id="inp-code" type="text" placeholder="code du canal..."/>
    <input id="inp-callsign" type="text" placeholder="votre indicatif (ex: ADJ MARTIN)..."/>
    <button class="btn" onclick="doJoin()">‚ñ∂ Rejoindre</button>

    <div class="status" id="setup-status"></div>
  </div>

  <!-- ===== CONNECTING ===== -->
  <div id="screen-connecting" style="display:none">
    <div class="connecting">
      <div>CONNEXION AU CANAL<span class="dot-anim"></span></div>
    </div>
  </div>

  <!-- ===== PTT ===== -->
  <div id="screen-ptt">

    <div class="info-box">
      <div class="info-row">
        <span class="key">Canal</span>
        <span class="val" id="disp-canal">‚Äî</span>
      </div>
      <div class="info-row">
        <span class="key">Indicatif</span>
        <span class="val green" id="disp-callsign">‚Äî</span>
      </div>
      <div class="info-row">
        <span class="key">Unit√©s</span>
        <span class="val" id="disp-units">0</span>
      </div>
      <div class="info-row">
        <span class="key">Code √† partager</span>
        <button class="copy-btn" onclick="copyCode()" id="copy-btn">COPIER</button>
      </div>
    </div>

    <div class="users" id="users-list"></div>

    <div class="ptt-area">
      <div class="rx-line" id="rx-line">EN VEILLE</div>
      <button id="ptt-btn"
        onmousedown="startTx()" onmouseup="stopTx()"
        ontouchstart="startTx(event)" ontouchend="stopTx(event)">
        <div class="ptt-icon">üéô</div>
        <div id="ptt-txt">PARLER</div>
      </button>
      <div style="font-size:0.6rem;color:#4a4a3a;letter-spacing:.12em;text-align:center">
        Maintenir pour √©mettre ¬∑ [ESPACE]
      </div>
    </div>

  </div>

</div>

<!-- Audio -->
<div id="audios" style="display:none"></div>

<script>
// ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let peer       = null;
let myId       = '';
let myCallsign = '';
let roomId     = '';
let micStream  = null;
let isHost     = false;

// peerId => { conn, call, callsign, speaking }
const peers = {};

// ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const $ = id => document.getElementById(id);

function setStatus(msg, cls='') {
  const el = $('setup-status');
  el.textContent = msg;
  el.className = 'status ' + cls;
}

function showScreen(name) {
  ['setup','connecting','ptt'].forEach(s => {
    const el = $('screen-'+s);
    if (el) el.style.display = s === name ? 'block' : 'none';
  });
}

async function getMic() {
  micStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
  micStream.getAudioTracks().forEach(t => t.enabled = false);
}

function silentStream() {
  return new AudioContext().createMediaStreamDestination().stream;
}

function addAudio(pid, stream) {
  removeAudio(pid);
  const a = document.createElement('audio');
  a.id = 'aud-' + pid;
  a.autoplay = true;
  a.srcObject = stream;
  $('audios').appendChild(a);
  a.play().catch(() => {});
}

function removeAudio(pid) {
  const el = $('aud-' + pid);
  if (el) el.remove();
}

// ‚îÄ‚îÄ‚îÄ UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderUsers() {
  const ul = $('users-list');
  ul.innerHTML = '';

  // Moi
  const me = document.createElement('div');
  me.className = 'u-row';
  me.innerHTML = `<span class="u-name me">‚ñ∂ ${esc(myCallsign)}</span><span class="u-badge" id="badge-me">MOI</span>`;
  ul.appendChild(me);

  for (const [pid, p] of Object.entries(peers)) {
    const row = document.createElement('div');
    row.className = 'u-row';
    row.id = 'urow-' + pid;
    const badge = p.speaking
      ? `<span class="u-badge speaking">‚óè PARLE</span>`
      : `<span class="u-badge">EN LIGNE</span>`;
    row.innerHTML = `<span class="u-name">${esc(p.callsign)}</span>${badge}`;
    ul.appendChild(row);
  }

  $('disp-units').textContent = Object.keys(peers).length;
  updateRx();
}

function updateRx() {
  const speaking = Object.values(peers).filter(p => p.speaking);
  const rx = $('rx-line');
  if (speaking.length > 0) {
    rx.className = 'rx-line active';
    rx.textContent = '‚óè R√âCEPTION ‚Äî ' + speaking.map(p=>p.callsign).join(', ');
  } else {
    rx.className = 'rx-line';
    rx.textContent = 'EN VEILLE';
  }
}

function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function copyCode() {
  const code = roomId.replace('srtc-','');
  navigator.clipboard.writeText(code).then(() => {
    const b = $('copy-btn');
    b.textContent = 'COPI√â !';
    setTimeout(() => b.textContent = 'COPIER', 2000);
  });
}

function switchToPTT() {
  $('disp-canal').textContent    = roomId.replace('srtc-','').toUpperCase();
  $('disp-callsign').textContent = myCallsign;
  showScreen('ptt');
  renderUsers();
}

// ‚îÄ‚îÄ‚îÄ Mesh data protocol ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// { type:'hello', callsign }
// { type:'peer-list', peers:[{id,callsign}] }
// { type:'speaking', val:bool }

function broadcast(msg) {
  for (const p of Object.values(peers)) {
    if (p.conn && p.conn.open) try { p.conn.send(msg); } catch(e) {}
  }
}

function onData(fromId, msg) {
  if (!peers[fromId]) return;
  if (msg.type === 'hello') {
    peers[fromId].callsign = msg.callsign;
    renderUsers();
  }
  if (msg.type === 'speaking') {
    peers[fromId].speaking = msg.val;
    updateRx();
    const row = $('urow-' + fromId);
    if (row) {
      const b = row.querySelector('.u-badge');
      if (msg.val) { b.className='u-badge speaking'; b.textContent='‚óè PARLE'; }
      else          { b.className='u-badge'; b.textContent='EN LIGNE'; }
    }
  }
  if (msg.type === 'peer-list') {
    for (const p of msg.peers) {
      if (p.id !== myId && !peers[p.id]) {
        connectPeer(p.id, p.callsign);
      }
    }
  }
}

// ‚îÄ‚îÄ‚îÄ Connect to a peer (outgoing) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function connectPeer(pid, knownCallsign) {
  if (peers[pid]) return;
  peers[pid] = { conn: null, call: null, callsign: knownCallsign || pid.slice(0,8), speaking: false };

  // Data
  const conn = peer.connect(pid, { reliable: true });
  peers[pid].conn = conn;
  conn.on('open', () => {
    conn.send({ type: 'hello', callsign: myCallsign });
    // Tell them about other peers
    const list = Object.entries(peers)
      .filter(([id]) => id !== pid)
      .map(([id, p]) => ({ id, callsign: p.callsign }));
    if (list.length) conn.send({ type: 'peer-list', peers: list });
  });
  conn.on('data',  msg => onData(pid, msg));
  conn.on('close', ()  => removePeer(pid));
  conn.on('error', ()  => removePeer(pid));

  // Media
  const call = peer.call(pid, micStream || silentStream());
  peers[pid].call = call;
  call.on('stream', s => addAudio(pid, s));
  call.on('close',  () => removeAudio(pid));
  call.on('error',  () => removeAudio(pid));

  renderUsers();
}

function removePeer(pid) {
  removeAudio(pid);
  delete peers[pid];
  renderUsers();
}

// ‚îÄ‚îÄ‚îÄ Incoming connections ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setupIncoming() {
  // Incoming data
  peer.on('connection', conn => {
    const pid = conn.peer;
    if (!peers[pid]) peers[pid] = { conn, call: null, callsign: pid.slice(0,8), speaking: false };
    else peers[pid].conn = conn;

    conn.on('open', () => {
      conn.send({ type: 'hello', callsign: myCallsign });
      // If host: send peer list
      if (isHost) {
        const list = Object.entries(peers)
          .filter(([id]) => id !== pid)
          .map(([id, p]) => ({ id, callsign: p.callsign }));
        if (list.length) conn.send({ type: 'peer-list', peers: list });
        // Notify others about new peer
        broadcast({ type: 'peer-list', peers: [{ id: pid, callsign: peers[pid].callsign }] });
      }
    });
    conn.on('data',  msg => onData(pid, msg));
    conn.on('close', ()  => removePeer(pid));
    conn.on('error', ()  => removePeer(pid));
    renderUsers();
  });

  // Incoming media
  peer.on('call', call => {
    const pid = call.peer;
    if (!peers[pid]) peers[pid] = { conn: null, call, callsign: pid.slice(0,8), speaking: false };
    else peers[pid].call = call;
    call.answer(micStream || silentStream());
    call.on('stream', s => addAudio(pid, s));
    call.on('close',  () => removeAudio(pid));
    renderUsers();
  });
}

// ‚îÄ‚îÄ‚îÄ CREATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function doCreate() {
  const raw = $('inp-create').value.trim().replace(/\s+/g,'-') || Math.random().toString(36).substr(2,5).toUpperCase();
  roomId     = 'srtc-' + raw;
  myCallsign = 'COMMANDANT';
  isHost     = true;

  setStatus('Acc√®s microphone...');
  try { await getMic(); } catch(e) { setStatus('Micro refus√© : ' + e.message, 'err'); return; }

  setStatus('Ouverture du canal...');
  showScreen('connecting');

  peer = new Peer(roomId, { debug: 0 });

  peer.on('open', id => {
    myId = id;
    setupIncoming();
    switchToPTT();
  });

  peer.on('error', e => {
    showScreen('setup');
    if (e.type === 'unavailable-id') setStatus('Ce nom de canal est d√©j√† pris.', 'err');
    else setStatus('Erreur : ' + e.message, 'err');
  });
}

// ‚îÄ‚îÄ‚îÄ JOIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function doJoin() {
  const code = $('inp-code').value.trim();
  const cs   = $('inp-callsign').value.trim();
  if (!code) { setStatus('Entrez un code de canal.', 'err'); return; }

  roomId     = code.startsWith('srtc-') ? code : 'srtc-' + code;
  myCallsign = cs || 'AGENT-' + Math.random().toString(36).substr(2,4).toUpperCase();
  isHost     = false;

  setStatus('Acc√®s microphone...');
  try { await getMic(); } catch(e) { setStatus('Micro refus√© : ' + e.message, 'err'); return; }

  setStatus('Connexion...');
  showScreen('connecting');

  peer = new Peer(undefined, { debug: 0 });

  peer.on('open', id => {
    myId = id;
    setupIncoming();

    // Init slot for host
    peers[roomId] = { conn: null, call: null, callsign: 'COMMANDANT', speaking: false };

    // Data to host
    const conn = peer.connect(roomId, { reliable: true });
    peers[roomId].conn = conn;
    conn.on('open', () => {
      conn.send({ type: 'hello', callsign: myCallsign });
      switchToPTT(); // ‚Üê on switch APR√àS que la connexion data est ouverte
    });
    conn.on('data',  msg => onData(roomId, msg));
    conn.on('close', ()  => removePeer(roomId));
    conn.on('error', ()  => {
      showScreen('setup');
      setStatus('Canal introuvable ‚Äî v√©rifiez le code.', 'err');
    });

    // Media to host
    const call = peer.call(roomId, micStream || silentStream());
    peers[roomId].call = call;
    call.on('stream', s => addAudio(roomId, s));
    call.on('close',  () => removeAudio(roomId));
    call.on('error',  () => {});
  });

  peer.on('error', e => {
    showScreen('setup');
    if (e.type === 'peer-unavailable') setStatus('Canal introuvable ‚Äî v√©rifiez le code.', 'err');
    else setStatus('Erreur : ' + e.message, 'err');
  });
}

// ‚îÄ‚îÄ‚îÄ PTT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startTx(e) {
  if (e) e.preventDefault();
  if (!micStream) return;
  micStream.getAudioTracks().forEach(t => t.enabled = true);
  $('ptt-btn').classList.add('tx');
  $('ptt-txt').textContent = '√âMISSION';
  $('rx-line').className = 'rx-line tx';
  $('rx-line').textContent = '‚óè VOUS TRANSMETTEZ';
  broadcast({ type: 'speaking', val: true });
}

function stopTx(e) {
  if (e) e.preventDefault();
  if (!micStream) return;
  micStream.getAudioTracks().forEach(t => t.enabled = false);
  $('ptt-btn').classList.remove('tx');
  $('ptt-txt').textContent = 'PARLER';
  updateRx();
  broadcast({ type: 'speaking', val: false });
}

// Keyboard
document.addEventListener('keydown', e => {
  if (e.code === 'Space' && $('screen-ptt').style.display !== 'none') {
    e.preventDefault();
    if (!e.repeat) startTx();
  }
});
document.addEventListener('keyup', e => {
  if (e.code === 'Space' && $('screen-ptt').style.display !== 'none') stopTx();
});
</script>
</body>
</html>
