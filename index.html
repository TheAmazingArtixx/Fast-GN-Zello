<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Radio Tactique</title>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: Arial, sans-serif;
  background: #0d1b2e;
  color: #cce0ff;
  min-height: 100vh;
  display: flex; align-items: center; justify-content: center;
  padding: 20px;
}
.app { width: 100%; max-width: 360px; }
.hdr {
  background: #112240; border-bottom: 2px solid #2a6fff;
  padding: 14px 16px; margin-bottom: 20px; border-radius: 6px;
}
.hdr h1 { font-size: 1rem; color: #6ab0ff; font-weight: 700; }
.hdr p  { font-size: 0.62rem; color: #3a6090; margin-top: 2px; }
.card {
  background: #112240; border: 1px solid #1e4080;
  border-radius: 6px; padding: 18px; margin-bottom: 12px;
}
.card-title {
  font-size: 0.68rem; color: #3a6090; text-transform: uppercase;
  letter-spacing: 0.1em; margin-bottom: 12px;
  padding-bottom: 8px; border-bottom: 1px solid #1a3060;
}
label { display: block; font-size: 0.72rem; color: #7aabdd; margin-bottom: 5px; }
input {
  display: block; width: 100%;
  background: #0a1525; border: 1px solid #1e4080; border-radius: 4px;
  color: #cce0ff; padding: 9px 11px; font-size: 0.9rem;
  font-family: Arial, sans-serif; outline: none; margin-bottom: 12px;
}
input:focus { border-color: #2a6fff; }
input::placeholder { color: #2a4060; }
.btn {
  display: block; width: 100%; padding: 10px;
  background: #1a3f7a; border: 1px solid #2a6fff; border-radius: 4px;
  color: #6ab0ff; font-size: 0.85rem; font-weight: bold;
  cursor: pointer; font-family: Arial, sans-serif;
}
.btn:hover { background: #204a8a; }
.btn:disabled { opacity: 0.4; cursor: not-allowed; }
.sep { text-align: center; font-size: 0.7rem; color: #2a4060; margin: 6px 0 12px; }
.err-box {
  background: #1a0d0d; border: 1px solid #c04040; color: #ff8080;
  padding: 10px 12px; border-radius: 4px; font-size: 0.73rem;
  margin-top: 10px; display: none; line-height: 1.6;
}
#screen-loading { display:none; text-align:center; padding: 50px 0; }
.spinner {
  width: 40px; height: 40px; border: 3px solid #1e4080;
  border-top-color: #2a6fff; border-radius: 50%;
  animation: spin .8s linear infinite; margin: 0 auto 14px;
}
@keyframes spin { to { transform: rotate(360deg); } }
.spin-txt { font-size: 0.8rem; color: #6ab0ff; margin-bottom: 6px; }
.spin-sub { font-size: 0.62rem; color: #3a6090; margin-top: 4px; }
.cancel-lnk {
  display: inline-block; margin-top: 20px;
  font-size: 0.7rem; color: #2a5080; cursor: pointer; text-decoration: underline;
}
#screen-ptt { display:none; }
.info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; }
.info-cell { background: #0a1525; border: 1px solid #1a3060; border-radius: 4px; padding: 10px; }
.info-cell .lbl { font-size: 0.58rem; color: #3a6090; text-transform: uppercase; }
.info-cell .val { font-size: 0.88rem; color: #6ab0ff; margin-top: 3px; font-weight: bold; }
.share-row {
  background: #0a1525; border: 1px solid #1a3060; border-radius: 4px;
  padding: 9px 12px; margin-bottom: 12px;
  display: flex; align-items: center; justify-content: space-between; gap: 10px;
}
.share-row .lbl { font-size: 0.58rem; color: #3a6090; text-transform: uppercase; }
.share-row .code { font-size: 0.95rem; color: #6ab0ff; font-weight: bold; margin-top: 2px; }
.sbtn {
  background: #1a3060; border: 1px solid #2a6fff; border-radius: 3px;
  color: #6ab0ff; font-size: 0.62rem; padding: 5px 10px;
  cursor: pointer; font-family: Arial, sans-serif; white-space: nowrap;
}
.sbtn:hover { background: #204070; }
.users-box { background: #0a1525; border: 1px solid #1a3060; border-radius: 4px; margin-bottom: 12px; }
.users-hdr { font-size: 0.62rem; color: #3a6090; text-transform: uppercase; padding: 7px 12px; border-bottom: 1px solid #0d1b2e; }
.u-row { display: flex; justify-content: space-between; align-items: center; padding: 7px 12px; font-size: 0.78rem; border-bottom: 1px solid #0d1b2e; }
.u-row:last-child { border-bottom: none; }
.u-name { color: #aaccee; }
.u-name.me { color: #6ab0ff; }
.u-badge { font-size: 0.6rem; padding: 2px 7px; border-radius: 3px; border: 1px solid #1e4080; color: #3a6090; }
.u-badge.sp { border-color: #2a9fff; color: #2a9fff; animation: bl .6s infinite; }
@keyframes bl { 0%,100%{opacity:1} 50%{opacity:.2} }
.ptt-area { display: flex; flex-direction: column; align-items: center; gap: 12px; padding: 16px; }
.rx-bar { width: 100%; padding: 8px 12px; border-radius: 4px; background: #0a1525; border: 1px solid #1a3060; font-size: 0.7rem; color: #3a6090; text-align: center; }
.rx-bar.rx { color: #2a9fff; border-color: #2a6fff; }
.rx-bar.tx { color: #ff6060; border-color: #c04040; }
#ptt-btn {
  width: 130px; height: 130px; border-radius: 50%;
  border: 3px solid #1e4080;
  background: radial-gradient(circle at 40% 35%, #1a3a7a, #0d1b2e);
  color: #6ab0ff; font-size: 0.7rem; font-weight: bold;
  font-family: Arial, sans-serif; cursor: pointer;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  gap: 8px; user-select: none; -webkit-user-select: none;
  box-shadow: 0 4px 0 #060e1c; transition: all 0.08s;
}
#ptt-btn .icon { font-size: 1.8rem; }
#ptt-btn.tx {
  transform: translateY(3px); box-shadow: 0 1px 0 #060e1c;
  border-color: #c04040;
  background: radial-gradient(circle at 40% 35%, #3a1010, #1a0505);
  color: #ff8080;
}
.ptt-hint { font-size: 0.6rem; color: #2a4060; text-align: center; }
</style>
</head>
<body>
<div class="app">

  <div class="hdr">
    <h1>&#128225; Radio Tactique</h1>
    <p>GENDARMERIE NATIONALE</p>
  </div>

  <!-- SETUP -->
  <div id="screen-setup">
    <div class="card">
      <div class="card-title">Creer un canal</div>
      <label>Nom du canal</label>
      <input id="in-name" type="text" placeholder="ex : ALPHA7"/>
      <button class="btn" id="btn-create" onclick="doCreate()">Creer</button>
    </div>
    <div class="sep">ou</div>
    <div class="card">
      <div class="card-title">Rejoindre un canal</div>
      <label>Code du canal</label>
      <input id="in-code" type="text" placeholder="code fourni par le createur"/>
      <label>Votre indicatif</label>
      <input id="in-cs" type="text" placeholder="ex : ADJ MARTIN"/>
      <button class="btn" id="btn-join" onclick="doJoin()">Rejoindre</button>
    </div>
    <div class="err-box" id="err-box"></div>
  </div>

  <!-- LOADING -->
  <div id="screen-loading">
    <div class="spinner"></div>
    <div class="spin-txt" id="spin-txt">Connexion...</div>
    <div class="spin-sub" id="spin-sub"></div>
    <div class="cancel-lnk" onclick="doCancel()">Annuler</div>
  </div>

  <!-- PTT -->
  <div id="screen-ptt">
    <div class="info-grid">
      <div class="info-cell"><div class="lbl">Canal</div><div class="val" id="d-canal">-</div></div>
      <div class="info-cell"><div class="lbl">Indicatif</div><div class="val" id="d-cs">-</div></div>
    </div>
    <div class="share-row">
      <div>
        <div class="lbl">Code a partager</div>
        <div class="code" id="d-code">-</div>
      </div>
      <button class="sbtn" id="sbtn" onclick="copyCode()">Copier</button>
    </div>
    <div class="users-box">
      <div class="users-hdr">Unites (<span id="d-units">0</span>)</div>
      <div id="ulist"></div>
    </div>
    <div class="card" style="padding:0">
      <div class="ptt-area">
        <div class="rx-bar" id="rxbar">En veille</div>
        <button id="ptt-btn"
          onmousedown="startTx()" onmouseup="stopTx()"
          ontouchstart="startTx(event)" ontouchend="stopTx(event)">
          <div class="icon">&#127897;</div>
          <div id="ptt-lbl">PARLER</div>
        </button>
        <div class="ptt-hint">Maintenir pour emettre [Espace]</div>
      </div>
    </div>
  </div>

</div>
<div id="audios" style="display:none"></div>

<script>
var $ = function(id) { return document.getElementById(id); };

// Pas de config custom — on laisse PeerJS utiliser son propre serveur par defaut
// C'est le plus fiable
var peer = null;
var myId = '', myCallsign = '', roomId = '', isHost = false;
var micStream = null;
var peers = {};
var cancelTimer = null;

function show(name) {
  ['setup','loading','ptt'].forEach(function(s) {
    $('screen-'+s).style.display = s === name ? 'block' : 'none';
  });
}

function setLoading(txt, sub) {
  $('spin-txt').textContent = txt;
  $('spin-sub').textContent = sub || '';
  show('loading');
}

function showErr(msg) {
  var el = $('err-box');
  el.textContent = msg;
  el.style.display = 'block';
}

function clearErr() { $('err-box').style.display = 'none'; }

function setBtns(on) {
  $('btn-create').disabled = !on;
  $('btn-join').disabled = !on;
}

function doCancel() {
  if (cancelTimer) { clearTimeout(cancelTimer); cancelTimer = null; }
  if (peer) { try { peer.destroy(); } catch(e){} peer = null; }
  if (micStream) { micStream.getTracks().forEach(function(t){ t.stop(); }); micStream = null; }
  Object.keys(peers).forEach(function(k){ delete peers[k]; });
  setBtns(true);
  show('setup');
}

function addAudio(pid, stream) {
  var ex = $('a-'+pid);
  if (ex) ex.remove();
  var a = document.createElement('audio');
  a.id = 'a-'+pid; a.autoplay = true; a.srcObject = stream;
  $('audios').appendChild(a);
  a.play().catch(function(){});
}
function removeAudio(pid) { var e = $('a-'+pid); if (e) e.remove(); }

function getMic(cb, errcb) {
  navigator.mediaDevices.getUserMedia({ audio: true, video: false })
    .then(function(s) {
      micStream = s;
      micStream.getAudioTracks().forEach(function(t){ t.enabled = false; });
      cb();
    }).catch(errcb);
}

function render() {
  var ul = $('ulist');
  ul.innerHTML = '';
  var me = document.createElement('div');
  me.className = 'u-row';
  me.innerHTML = '<span class="u-name me">' + esc(myCallsign) + ' (moi)</span><span class="u-badge" style="color:#2a6fff">EN LIGNE</span>';
  ul.appendChild(me);
  Object.keys(peers).forEach(function(id) {
    var p = peers[id];
    var d = document.createElement('div');
    d.className = 'u-row'; d.id = 'r-'+id;
    d.innerHTML = '<span class="u-name">' + esc(p.callsign) + '</span><span class="u-badge' + (p.speaking?' sp':'') + '">' + (p.speaking ? 'PARLE' : 'EN LIGNE') + '</span>';
    ul.appendChild(d);
  });
  $('d-units').textContent = Object.keys(peers).length;
  updateRx();
}

function updateRx() {
  var sp = Object.keys(peers).filter(function(id){ return peers[id].speaking; });
  var rx = $('rxbar');
  if (sp.length) {
    rx.className = 'rx-bar rx';
    rx.textContent = 'Reception : ' + sp.map(function(id){ return peers[id].callsign; }).join(', ');
  } else {
    rx.className = 'rx-bar';
    rx.textContent = 'En veille';
  }
}

function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;'); }

function copyCode() {
  navigator.clipboard.writeText(roomId).then(function() {
    $('sbtn').textContent = 'Copie!';
    setTimeout(function(){ $('sbtn').textContent = 'Copier'; }, 2000);
  });
}

function broadcast(msg) {
  Object.keys(peers).forEach(function(id) {
    var p = peers[id];
    if (p.conn && p.conn.open) { try { p.conn.send(msg); } catch(e){} }
  });
}

function onData(fromId, msg) {
  if (!peers[fromId]) return;
  if (msg.type === 'hello') { peers[fromId].callsign = msg.cs; render(); }
  if (msg.type === 'speaking') { peers[fromId].speaking = msg.val; render(); }
  if (msg.type === 'peers') {
    msg.list.forEach(function(p) {
      if (p.id !== myId && !peers[p.id]) connectOut(p.id, p.cs);
    });
  }
}

function connectOut(pid, knownCs) {
  if (peers[pid]) return;
  peers[pid] = { conn: null, call: null, callsign: knownCs || '???', speaking: false };
  var conn = peer.connect(pid, { reliable: true, serialization: 'json' });
  peers[pid].conn = conn;
  conn.on('open', function() {
    conn.send({ type: 'hello', cs: myCallsign });
    var list = Object.keys(peers).filter(function(id){ return id !== pid; }).map(function(id){ return { id: id, cs: peers[id].callsign }; });
    if (list.length) conn.send({ type: 'peers', list: list });
  });
  conn.on('data', function(msg){ onData(pid, msg); });
  conn.on('close', function(){ delete peers[pid]; removeAudio(pid); render(); });
  conn.on('error', function(){ delete peers[pid]; removeAudio(pid); render(); });
  var call = peer.call(pid, micStream);
  peers[pid].call = call;
  call.on('stream', function(s){ addAudio(pid, s); });
  call.on('close', function(){ removeAudio(pid); });
  call.on('error', function(){ removeAudio(pid); });
  render();
}

function setupIncoming() {
  peer.on('connection', function(conn) {
    var pid = conn.peer;
    if (!peers[pid]) peers[pid] = { conn: conn, call: null, callsign: '???', speaking: false };
    else peers[pid].conn = conn;
    conn.on('open', function() {
      conn.send({ type: 'hello', cs: myCallsign });
      if (isHost) {
        var list = Object.keys(peers).filter(function(id){ return id !== pid; }).map(function(id){ return { id: id, cs: peers[id].callsign }; });
        if (list.length) conn.send({ type: 'peers', list: list });
        broadcast({ type: 'peers', list: [{ id: pid, cs: peers[pid].callsign }] });
      }
    });
    conn.on('data', function(msg){ onData(pid, msg); });
    conn.on('close', function(){ delete peers[pid]; removeAudio(pid); render(); });
    conn.on('error', function(){ delete peers[pid]; removeAudio(pid); render(); });
    render();
  });
  peer.on('call', function(call) {
    var pid = call.peer;
    if (!peers[pid]) peers[pid] = { conn: null, call: call, callsign: '???', speaking: false };
    else peers[pid].call = call;
    call.answer(micStream);
    call.on('stream', function(s){ addAudio(pid, s); });
    call.on('close', function(){ removeAudio(pid); });
    render();
  });
}

function goToPTT() {
  if (cancelTimer) { clearTimeout(cancelTimer); cancelTimer = null; }
  $('d-canal').textContent = roomId.toUpperCase();
  $('d-cs').textContent = myCallsign;
  $('d-code').textContent = roomId.toUpperCase();
  show('ptt');
  render();
}

// ── CREER ─────────────────────────────────────────────────────
function doCreate() {
  clearErr(); setBtns(false);
  var raw = ($('in-name').value.trim() || Math.random().toString(36).substr(2,5)).toUpperCase().replace(/\s+/g,'');
  roomId = raw;
  myCallsign = 'COMMANDANT';
  isHost = true;

  setLoading('Acces microphone...');
  getMic(function() {
    setLoading('Creation du canal...', roomId);
    // PeerJS sans aucune config = serveur par defaut (peerjs.com)
    peer = new Peer(roomId);

    cancelTimer = setTimeout(function() {
      doCancel();
      showErr('Le serveur ne repond pas. Reessayez dans quelques secondes.');
    }, 20000);

    peer.on('open', function(id) {
      myId = id;
      setupIncoming();
      goToPTT();
    });

    peer.on('error', function(e) {
      if (cancelTimer) { clearTimeout(cancelTimer); cancelTimer = null; }
      // unavailable-id = nom pris, on en genere un nouveau auto
      if (e.type === 'unavailable-id') {
        try { peer.destroy(); } catch(ex){}
        roomId = raw + Math.random().toString(36).substr(2,3).toUpperCase();
        peer = new Peer(roomId);
        cancelTimer = setTimeout(function() { doCancel(); showErr('Impossible de creer le canal. Reessayez.'); }, 15000);
        peer.on('open', function(id) { myId = id; setupIncoming(); goToPTT(); });
        peer.on('error', function(e2) {
          if (cancelTimer) { clearTimeout(cancelTimer); cancelTimer = null; }
          show('setup'); setBtns(true);
          showErr('Erreur : ' + e2.type);
        });
      } else {
        show('setup'); setBtns(true);
        showErr('Erreur : ' + e.type + '. Reessayez.');
      }
    });
  }, function() {
    show('setup'); setBtns(true);
    showErr('Microphone refuse. Autorisez-le dans les parametres de votre navigateur.');
  });
}

// ── REJOINDRE ─────────────────────────────────────────────────
function doJoin() {
  clearErr(); setBtns(false);
  var code = $('in-code').value.trim().toUpperCase().replace(/\s+/g,'');
  var cs = $('in-cs').value.trim();
  if (!code) { setBtns(true); showErr('Entrez un code de canal.'); return; }

  roomId = code;
  myCallsign = cs || 'AGENT-' + Math.random().toString(36).substr(2,4).toUpperCase();
  isHost = false;

  setLoading('Acces microphone...');
  getMic(function() {
    setLoading('Connexion au canal...', roomId);

    // PeerJS sans config = serveur par defaut
    peer = new Peer();

    cancelTimer = setTimeout(function() {
      doCancel();
      showErr('Impossible de joindre le serveur PeerJS. Reessayez.');
    }, 20000);

    peer.on('open', function(id) {
      myId = id;
      setupIncoming();

      // On se connecte a l'hote
      peers[roomId] = { conn: null, call: null, callsign: 'COMMANDANT', speaking: false };
      var conn = peer.connect(roomId, { reliable: true, serialization: 'json' });
      peers[roomId].conn = conn;

      var opened = false;

      // Timeout specifique pour la connexion au canal (si le canal n'existe pas)
      var connTimer = setTimeout(function() {
        if (!opened) {
          if (cancelTimer) { clearTimeout(cancelTimer); cancelTimer = null; }
          doCancel();
          showErr('Canal "' + roomId + '" introuvable. Verifiez que le createur a bien le canal ouvert.');
        }
      }, 10000);

      conn.on('open', function() {
        opened = true;
        clearTimeout(connTimer);
        if (cancelTimer) { clearTimeout(cancelTimer); cancelTimer = null; }
        conn.send({ type: 'hello', cs: myCallsign });

        var call = peer.call(roomId, micStream);
        peers[roomId].call = call;
        call.on('stream', function(s){ addAudio(roomId, s); });
        call.on('close', function(){ removeAudio(roomId); });
        call.on('error', function(){});

        goToPTT();
      });

      conn.on('data', function(msg){ onData(roomId, msg); });
      conn.on('close', function(){ delete peers[roomId]; removeAudio(roomId); render(); });
      conn.on('error', function() {
        clearTimeout(connTimer);
        if (!opened) {
          if (cancelTimer) { clearTimeout(cancelTimer); cancelTimer = null; }
          show('setup'); setBtns(true);
          showErr('Canal "' + roomId + '" introuvable. Le createur doit avoir la page ouverte.');
        }
      });
    });

    peer.on('error', function(e) {
      if (cancelTimer) { clearTimeout(cancelTimer); cancelTimer = null; }
      show('setup'); setBtns(true);
      if (e.type === 'peer-unavailable') {
        showErr('Canal "' + roomId + '" introuvable. Le createur doit avoir la page ouverte.');
      } else {
        showErr('Erreur reseau : ' + e.type + '. Reessayez.');
      }
    });

  }, function() {
    show('setup'); setBtns(true);
    showErr('Microphone refuse. Autorisez-le dans les parametres de votre navigateur.');
  });
}

// ── PTT ───────────────────────────────────────────────────────
function startTx(e) {
  if (e) e.preventDefault();
  if (!micStream) return;
  micStream.getAudioTracks().forEach(function(t){ t.enabled = true; });
  $('ptt-btn').classList.add('tx');
  $('ptt-lbl').textContent = 'EMISSION';
  $('rxbar').className = 'rx-bar tx';
  $('rxbar').textContent = 'Vous transmettez';
  broadcast({ type: 'speaking', val: true });
}

function stopTx(e) {
  if (e) e.preventDefault();
  if (!micStream) return;
  micStream.getAudioTracks().forEach(function(t){ t.enabled = false; });
  $('ptt-btn').classList.remove('tx');
  $('ptt-lbl').textContent = 'PARLER';
  broadcast({ type: 'speaking', val: false });
  updateRx();
}

document.addEventListener('keydown', function(e) {
  if (e.code === 'Space' && $('screen-ptt').style.display !== 'none') {
    e.preventDefault(); if (!e.repeat) startTx();
  }
});
document.addEventListener('keyup', function(e) {
  if (e.code === 'Space' && $('screen-ptt').style.display !== 'none') stopTx();
});
</script>
</body>
</html>
